AWSTemplateFormatVersion: '2010-09-09'  # Versión del formato de plantilla de AWS

Parameters:
  mykeypair: 
    Type: AWS::EC2::KeyPair::KeyName
    Description: Nombre del par de claves para acceder a la instancia
  InstanceTypeParameter:
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - m1.small
      - m1.large
    Description: Enter t2.micro, m1.small, or m1.large. Default is t2.micro.
  VolumeSize:
    Type: Number
    Default: 20
    Description: Tamaño del volumen EBS en GB
  VolumeType:
    Type: String
    Default: gp3
    AllowedValues:
      - gp2
      - gp3
      - io1
    Description: Tipo de volumen EBS (gp2, gp3, io1)
  SSHFromIP:
    Type: String
    Default: 0.0.0.0/0
    Description: La IP desde la que se permiten conexiones SSH
  HTTPFromIP:
    Type: String
    Default: 0.0.0.0/0
    Description: La IP desde la que se permiten conexiones HTTP
  HTTPSFromIP:
    Type: String
    Default: 0.0.0.0/0
    Description: La IP desde la que se permiten conexiones HTTPS

Resources:
  MyInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0648742c7600c103f
      InstanceType: !Ref InstanceTypeParameter
      KeyName: !Ref mykeypair
      BlockDeviceMappings:
        - DeviceName: "/dev/sdm"
          Ebs:
            VolumeType: !Ref VolumeType
            DeleteOnTermination: true
            VolumeSize: !Ref VolumeSize
      SecurityGroupIds:
        - !Ref ServerSecurityWeb
        - !Ref ServerSecurityPrivate

  ServerSecurityWeb:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow connections from specified public sites
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref HTTPFromIP
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref HTTPSFromIP

  ServerSecurityPrivate:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow connections from specified local sites
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHFromIP
